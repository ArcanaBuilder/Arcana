///////////////////////////////////////////////////////////////////////////////
// INCLUDES
///////////////////////////////////////////////////////////////////////////////

#include "Defines.h"
#include "Support.h"
#include "Parser.h"

#include <fstream>
#include <iostream>


///////////////////////////////////////////////////////////////////////////////
// USING
///////////////////////////////////////////////////////////////////////////////

USE_MODULE(Arcana);



///////////////////////////////////////////////////////////////////////////////
// PUBLIC PROTOS
///////////////////////////////////////////////////////////////////////////////




///////////////////////////////////////////////////////////////////////////////
// PRIVATE PROTOS
///////////////////////////////////////////////////////////////////////////////

static Arcana_Result run(const Support::Arguments& args);




///////////////////////////////////////////////////////////////////////////////
// MAIN
///////////////////////////////////////////////////////////////////////////////

int main(int argc, char** argv) 
{   
    Support::Arguments args = Support::ParseArgs(argc, argv);

    if (args.size() < 2)
    {
        ERR("Required at least one argument, the arcana-script file!");
        return Arcana_Result::ARCANA_RESULT__INVALID_ARGS;
    }

    return run(args);
}


///////////////////////////////////////////////////////////////////////////////
// PRIVATE FUNCTIONS
///////////////////////////////////////////////////////////////////////////////

static Arcana_Result run(const Support::Arguments& args)
{   
    Arcana_Result result = ARCANA_RESULT__OK;

    std::ifstream file(args[1].arg);

    Scan::Lexer       lexer(file);
    Grammar::Engine   engine;
    Parsing::Parser   parser(lexer, engine);
    Semantic::Enviroment   env;

    parser.Set_ParsingError_Handler (Support::ParserError   {lexer} );
    parser.Set_AnalisysError_Handler(Support::SemanticError {lexer} );
    
    result = parser.Parse(env);

#if DEBUG
    env.print();
#endif

    return result;
}