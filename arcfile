#!/usr/bin/arcana

using profiles Debug Release;
using default interpreter /bin/bash;
using threads 24;


COMPILER = g++

@profile Debug
FLAGS    = -std=c++17 -g3 -O0 -Wall -Wextra -pedantic -DDEBUG

@profile Release
FLAGS    = -std=c++17 -Os -Wall -Wextra -DRELEASE

INCLUDES = -Iinclude/common -Iinclude/core -Iinclude/parser -Iinclude/parser/util -Iinclude/core/util

TARGET   = {arc:BUILDDIR}/arcana
SOURCES  = {arc:SRCDIR}/**.cpp

@map SOURCES
OBJECTS  = {arc:BUILDDIR}/**.o

BUILDDIR = build
SRCDIR   = src


###########################
# PRIVATE TASKS
###########################


task MakeFolders() 
{
    cd {arc:SRCDIR}
    find . -type d -exec mkdir -p "../{arc:BUILDDIR}"/{} \;
}

@interpreter /bin/python3
task Message() 
{
print("Invoking arcana ({arc:__version__}) for {arc:TARGET} in {arc:__profile__} Mode")
}

@echo
@requires MakeFolders
@multithread
task Compile(SOURCES) 
{
    {arc:COMPILER} {arc:FLAGS} {arc:INCLUDES} -c {arc:list:SOURCES} -o {arc:list:OBJECTS}
}
    
    
task Link()
{        
    {arc:COMPILER} {arc:FLAGS} {arc:inline:OBJECTS} -o {arc:TARGET}
}


###########################
# PUBLIC TASKS
###########################

@pub
@flushcache
@then MakeFolders
task Clean() 
{ 
    rm -rf {arc:BUILDDIR}
}

@pub
@main
@requires Message Compile Link
task Build() {}

@pub
@requires Message Clean Build
task Rebuild() {}

@pub
@requires Clean Build
task Install()
{
    cp {arc:TARGET} /usr/bin/  
}